{{ $baseUrlObj := urls.Parse .Site.BaseURL }}
{{ $currentDomain := $baseUrlObj.Hostname }}

{{ with resources.Get "sass/loading-cube.scss" }}
  {{ $opts := dict
    "transpiler" "dartsass"
  }}
  {{ with . | toCSS $opts }}
    {{ with slice . | append (resources.Match "css/*") | resources.Concat "css/styles.css" }}
      {{ if hugo.IsProduction }}
        {{ with . | minify | fingerprint }}
          <link rel="stylesheet" href="{{ .RelPermalink }}" integrity="{{ .Data.Integrity }}" crossorigin="anonymous">
        {{ end }}
      {{ else }}
        <link rel="stylesheet" href="{{ .RelPermalink }}">
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

<!-- 添加预加载和样式锁定 -->
<link rel="preload" href="https://cdn.jsdelivr.net/npm/typeface-archivo-narrow@1.1.13/files/archivo-narrow-latin-300.woff2" as="font" type="font/woff2" crossorigin>
<style>
  /* 关键修复：确保退出前字体渲染状态稳定 */
  h1.loading-h1 {
    /* 添加字体渲染优化 */
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    /* 固定尺寸，防止重排 */
    width: 100%;
    height: 48px; /* 精确匹配字体高度 */
    line-height: 48px;
    /* 保持透明度变化时的位置稳定 */
    transform: translateZ(0);
  }
</style>

<div class="loading-container">
<div class="loading-bg"></div>
<div class="animation-background"></div>
    <h1 class="loading-h1">Welcome to Mikann-Crossline!</h1>
    <div class="cube-wrapper" id="loadingCubeContainer">
        <div class="cube-folding">
            <span class="leaf1"></span>
            <span class="leaf2"></span>
            <span class="leaf3"></span>
            <span class="leaf4"></span>
        </div>
        <span class="loading" data-name="Loading">Loading</span>
    </div>
    <div class="made-with-love">
        Made with
        <i>♥</i> Animation by
        <a target="_blank" href="https://codepen.io/nikhil8krishnan">Nikhil Krishnan</a>
    </div>
</div>
<script>
(function() {
    const CURRENT_DOMAIN = "{{ $currentDomain | safeJS }}";

    const loadingElements = [
        document.querySelector(".loading-bg"),
        document.getElementById("loadingCubeContainer"),
        document.querySelector(".animation-background"),
        document.querySelector(".loading-h1"),
        document.querySelector(".made-with-love")
    ];

    function shouldShowAnimation() {
        const referrer = document.referrer;
        if (!referrer) return true;
        try {
            return !new URL(referrer).hostname.includes(CURRENT_DOMAIN);
        } catch (e) {
            return true;
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        if (!loadingElements[0]) return;

        if (!shouldShowAnimation()) {
            loadingElements.forEach(el => el && (el.style.display = "none"));
            document.dispatchEvent(new CustomEvent("loadingAnimationComplete"));
            return;
        }

        loadingElements.forEach(el => el && (el.style.display = "block"));

        window.onload = () => {
            setTimeout(() => {
                // 关键修复：添加transform保持位置稳定
                loadingElements.forEach(el => {
                    if (el) {
                        el.style.transition = "opacity 0.8s ease-out, transform 0.8s ease-out";
                        el.style.opacity = "0";
                        // 微小位移防止字体渲染抖动
                        el.style.transform = "translateY(0.5px)";
                    }
                });

                // 延长移除时间，确保过渡完成
                setTimeout(() => {
                    loadingElements.forEach(el => el && el.remove());
                    document.dispatchEvent(new CustomEvent("loadingAnimationComplete"));
                }, 800); // 与过渡时间完全匹配
            }, 500);
        };
    });
})();
</script>
    
